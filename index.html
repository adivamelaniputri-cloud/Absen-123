<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Absensi Online - Supabase</title>
    <!-- Supabase Client Library -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .app-container {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
        }
        .card {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            padding: 1.5rem;
            transition: all 0.3s ease;
        }
        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
        }
        .btn-primary { background-color: #3b82f6; color: white; }
        .btn-primary:hover:not(:disabled) { background-color: #2563eb; }
        .btn-secondary { background-color: #6b7280; color: white; }
        .btn-secondary:hover { background-color: #4b5563; }
        .status-hadir { background-color: #dcfce7; color: #166534; }
        .status-sakit { background-color: #fef9c3; color: #854d0e; }
        .status-izin { background-color: #e0f2fe; color: #075985; }
        .photo-thumbnail {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
        }
        #custom-modal {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 1000; transition: opacity 0.3s ease;
        }
        #custom-modal .modal-content {
            background-color: white; padding: 2rem; border-radius: 12px;
            text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            transform: scale(0.95); transition: transform 0.3s ease;
            max-width: 90vw; max-height: 90vh;
        }
         #custom-modal.visible .modal-content { transform: scale(1); }
        #photo-viewer-img { max-width: 100%; max-height: 70vh; border-radius: 8px;}
        .tab-btn.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div id="app-container" class="app-container">
        
        <!-- ===== Unified Login Section ===== -->
        <div id="login-view" class="card max-w-lg mx-auto">
            <!-- Tabs -->
            <div class="flex border-b mb-6">
                <button id="show-student-login-tab" class="tab-btn flex-1 py-2 font-semibold text-center focus:outline-none active">
                    <i class="fas fa-user-graduate mr-2"></i>Absensi Siswa
                </button>
                <button id="show-teacher-login-tab" class="tab-btn flex-1 py-2 font-semibold text-gray-500 text-center focus:outline-none">
                    <i class="fas fa-chalkboard-teacher mr-2"></i>Login Guru
                </button>
            </div>
            
            <!-- Student Login Form -->
            <div id="student-login-form">
                <div class="mb-4">
                    <label for="student-name" class="block text-sm font-medium text-gray-600 mb-1">Nama Lengkap</label>
                    <input type="text" id="student-name" placeholder="Masukkan nama lengkap Anda" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="mb-4">
                    <label for="student-class" class="block text-sm font-medium text-gray-600 mb-1">Pilih Kelas</label>
                    <select id="student-class" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div id="student-login-error" class="text-red-500 text-sm mb-2 text-center h-4"></div>
                <button id="student-login-btn" class="btn btn-primary w-full mt-2">Lanjutkan</button>
            </div>
            
            <!-- Teacher Login Form -->
            <div id="teacher-login-form" class="hidden">
                 <div class="mb-4">
                    <label for="teacher-id" class="block text-sm font-medium text-gray-600 mb-1">ID Wali Kelas</label>
                    <input type="text" id="teacher-id" placeholder="Masukkan ID Anda" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                 <div class="mb-4">
                    <label for="teacher-password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                    <input type="password" id="teacher-password" placeholder="Masukkan password Anda" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                 </div>
                 <div id="teacher-login-error" class="text-red-500 text-sm mb-2 text-center h-4"></div>
                 <button id="teacher-login-btn" class="btn btn-secondary w-full mt-2">Masuk</button>
            </div>
        </div>

        <!-- ===== Student Dashboard ===== -->
        <div id="student-view" class="hidden">
             <div class="card mb-6 flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Dasbor Siswa</h2>
                    <p id="student-greeting" class="text-gray-600"></p>
                </div>
                <button id="student-logout-btn" class="btn btn-secondary">Keluar</button>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <!-- Attendance Action -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-3">Absensi Hari Ini</h3>
                    <p class="text-gray-500 text-sm mb-4" id="current-date"></p>
                    <div id="photo-section" class="mb-4">
                        <label for="photo-upload" class="block text-sm font-medium text-gray-600 mb-2">Upload Bukti Foto (Wajib untuk status Hadir)</label>
                        <input type="file" id="photo-upload" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <img id="photo-preview" class="hidden mt-4 rounded-lg w-full max-w-xs mx-auto shadow-md" alt="Preview Foto">
                    </div>
                    <div id="attendance-options">
                        <button onclick="markAttendance('Hadir')" class="btn btn-primary w-full mb-2"><i class="fas fa-check-circle mr-2"></i>Hadir</button>
                        <button onclick="markAttendance('Sakit')" class="btn bg-yellow-400 hover:bg-yellow-500 text-white w-full mb-2"><i class="fas fa-briefcase-medical mr-2"></i>Sakit</button>
                        <button onclick="markAttendance('Izin')" class="btn bg-sky-500 hover:bg-sky-600 text-white w-full"><i class="fas fa-file-alt mr-2"></i>Izin</button>
                    </div>
                    <div id="attendance-status" class="hidden text-center p-4 rounded-lg">
                        <p class="font-semibold"></p>
                    </div>
                </div>
                <!-- Attendance History -->
                <div class="card">
                    <h3 class="text-lg font-semibold mb-4">Riwayat Absensi Anda</h3>
                    <div class="overflow-y-auto max-h-96">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 text-gray-600 sticky top-0">
                                <tr>
                                    <th class="p-3">Tanggal</th>
                                    <th class="p-3">Status</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <tr><td colspan="2" class="text-center p-4">Memuat riwayat...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== Teacher Dashboard ===== -->
        <div id="teacher-view" class="hidden">
             <div class="card mb-6 flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h2 class="text-2xl font-bold">Dasbor Wali Kelas</h2>
                    <p id="teacher-greeting" class="text-gray-600"></p>
                </div>
                <button id="teacher-logout-btn" class="btn btn-secondary">Keluar</button>
            </div>
            <div class="card">
                <h3 class="text-lg font-semibold mb-1">Laporan Kehadiran Hari Ini</h3>
                <p class="text-gray-500 text-sm mb-4" id="report-date"></p>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-gray-50 text-gray-600">
                            <tr>
                                <th class="p-3">Nama Siswa</th>
                                <th class="p-3">Kelas</th>
                                <th class="p-3">Keterangan</th>
                                <th class="p-3">Bukti Foto</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body">
                            <tr><td colspan="4" class="text-center p-4">Memuat laporan...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Custom Modal -->
    <div id="custom-modal" class="hidden opacity-0 pointer-events-none">
        <div class="modal-content" id="modal-content-main">
            <p id="modal-message" class="text-lg"></p>
            <div id="photo-viewer" class="hidden">
                 <img id="photo-viewer-img" src="" alt="Bukti Foto">
                 <button id="close-photo-viewer" class="btn btn-secondary mt-4">Tutup</button>
            </div>
        </div>
    </div>

    <script type="module">
        // --- Supabase Config ---
        // !!! PENTING: Ganti dengan URL dan Kunci Anon Proyek Supabase Anda !!!
        const SUPABASE_URL = 'https://jjzkwvprbmgryxyyvpcz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Impqemt3dnByYm1ncnl4eXl2cGN6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA0MjExNDMsImV4cCI6MjA3NTk5NzE0M30.yCiBeF2ASayF0NdPEvi3P3uzSx5ttgczPJuV7X7cBsk';

        let supabaseClient;

        // Fix: Check for placeholder values before attempting to initialize Supabase.
        // This prevents the "Invalid supabaseUrl" error in the console.
        if (SUPABASE_URL === 'URL_PROYEK_SUPABASE_ANDA' || SUPABASE_ANON_KEY === 'KUNCI_ANON_SUPABASE_ANDA') {
            console.warn("Supabase belum dikonfigurasi. Silakan ganti placeholder URL dan Kunci Anon di dalam kode.");
            supabaseClient = null;
        } else {
            try {
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            } catch (error) {
                console.error("Gagal menginisialisasi Supabase:", error.message);
                supabaseClient = null;
            }
        }

        // --- App Config ---
        const BUCKET_NAME = 'bukti_foto';
        const classList = [
            'XII-A', 'XII-B', 'XII-C', 'XII-D', 'XII-E', 'XII-F', 
            'XII-G', 'XII-H', 'XII-I', 'XII-J', 'XII-K', 'XII-L'
        ];
        
        // --- Global State ---
        let currentUser = null;
        let uploadedPhotoFile = null;

        // --- UI Elements ---
        const loginView = document.getElementById('login-view');
        const studentView = document.getElementById('student-view');
        const teacherView = document.getElementById('teacher-view');
        const studentLoginForm = document.getElementById('student-login-form');
        const teacherLoginForm = document.getElementById('teacher-login-form');
        const studentTabBtn = document.getElementById('show-student-login-tab');
        const teacherTabBtn = document.getElementById('show-teacher-login-tab');
        const photoUpload = document.getElementById('photo-upload');
        const photoPreview = document.getElementById('photo-preview');
        const customModal = document.getElementById('custom-modal');
        const modalMessage = document.getElementById('modal-message');
        const photoViewer = document.getElementById('photo-viewer');
        const photoViewerImg = document.getElementById('photo-viewer-img');
        const attendanceOptionsDiv = document.getElementById('attendance-options');


        // --- Utility Functions ---
        const getTodayDateString = () => new Date().toISOString().split('T')[0];
        
        const showModal = (message, duration = 2500) => {
            photoViewer.classList.add('hidden');
            modalMessage.classList.remove('hidden');
            modalMessage.textContent = message;
            customModal.classList.remove('hidden');
            setTimeout(() => customModal.classList.add('visible'), 10);
            if(duration) {
                 setTimeout(hideModal, duration);
            }
        };
        
        const hideModal = () => {
            customModal.classList.remove('visible');
            setTimeout(() => customModal.classList.add('hidden'), 300);
        };
        
        window.showPhotoModal = (photoData) => {
            modalMessage.classList.add('hidden');
            photoViewer.classList.remove('hidden');
            photoViewerImg.src = photoData;
            customModal.classList.remove('hidden');
            setTimeout(() => customModal.classList.add('visible'), 10);
        };

        const toggleButtonLoading = (button, isLoading) => {
            if (isLoading) {
                button.disabled = true;
                button.innerHTML += '<div class="loader"></div>';
            } else {
                button.disabled = false;
                button.querySelector('.loader')?.remove();
            }
        };

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            if (!supabaseClient) {
                showModal('Konfigurasi Supabase tidak valid. Silakan periksa URL dan Kunci API pada kode.', null);
                document.getElementById('student-login-btn').disabled = true;
                document.getElementById('teacher-login-btn').disabled = true;
                return;
            }

            const classSelect = document.getElementById('student-class');
            classList.forEach(cls => {
                const option = document.createElement('option');
                option.value = cls;
                option.textContent = cls;
                classSelect.appendChild(option);
            });

            studentTabBtn.addEventListener('click', () => switchTab('student'));
            teacherTabBtn.addEventListener('click', () => switchTab('teacher'));
            document.getElementById('student-login-btn').addEventListener('click', handleStudentLogin);
            document.getElementById('teacher-login-btn').addEventListener('click', handleTeacherLogin);
            document.getElementById('student-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('teacher-logout-btn').addEventListener('click', handleLogout);
            document.getElementById('close-photo-viewer').addEventListener('click', hideModal);
            photoUpload.addEventListener('change', handlePhotoUpload);

            const formattedDate = new Date().toLocaleDateString('id-ID', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            document.getElementById('current-date').textContent = formattedDate;
            document.getElementById('report-date').textContent = formattedDate;
        });
        
        const switchTab = (tab) => {
            if (tab === 'student') {
                studentLoginForm.classList.remove('hidden');
                teacherLoginForm.classList.add('hidden');
                studentTabBtn.classList.add('active');
                teacherTabBtn.classList.remove('active');
                teacherTabBtn.classList.add('text-gray-500');
            } else {
                studentLoginForm.classList.add('hidden');
                teacherLoginForm.classList.remove('hidden');
                studentTabBtn.classList.remove('active');
                teacherTabBtn.classList.add('active');
                teacherTabBtn.classList.remove('text-gray-500');
            }
        };

        // --- Event Handlers ---
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            if (file) {
                uploadedPhotoFile = file;
                const reader = new FileReader();
                reader.onload = (e) => {
                    photoPreview.src = e.target.result;
                    photoPreview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        // --- Authentication & View Switching ---
        const handleStudentLogin = () => {
            const name = document.getElementById('student-name').value.trim();
            const selectedClass = document.getElementById('student-class').value;
            const errorDiv = document.getElementById('student-login-error');

            if (!name) {
                errorDiv.textContent = 'Nama tidak boleh kosong.';
                return;
            }
            errorDiv.textContent = '';
            currentUser = { name: name, class: selectedClass, role: 'student' };
            showStudentDashboard();
        };

        const handleTeacherLogin = async () => {
            const teacherId = document.getElementById('teacher-id').value.trim().toLowerCase();
            const password = document.getElementById('teacher-password').value;
            const errorDiv = document.getElementById('teacher-login-error');
            const button = document.getElementById('teacher-login-btn');
            
            toggleButtonLoading(button, true);

            const { data, error } = await supabaseClient
                .from('teachers')
                .select('*')
                .eq('id', teacherId)
                .eq('password', password) // Peringatan: Jangan gunakan password plaintext di produksi!
                .single();

            toggleButtonLoading(button, false);

            if (data) {
                errorDiv.textContent = '';
                currentUser = data; // Supabase returns a full object
                showTeacherDashboard();
            } else {
                errorDiv.textContent = 'ID atau Password salah.';
            }
        };

        const handleLogout = () => {
            currentUser = null;
            uploadedPhotoFile = null;
            studentView.classList.add('hidden');
            teacherView.classList.add('hidden');
            loginView.classList.remove('hidden');
            
            // Reset forms
            document.getElementById('student-name').value = '';
            document.getElementById('teacher-id').value = '';
            document.getElementById('teacher-password').value = '';
            photoUpload.value = '';
            photoPreview.classList.add('hidden');
            photoPreview.src = '';
            switchTab('student');
        };

        // --- Student Dashboard Logic ---
        const showStudentDashboard = () => {
            loginView.classList.add('hidden');
            studentView.classList.remove('hidden');
            document.getElementById('student-greeting').textContent = `Selamat datang, ${currentUser.name} (Kelas: ${currentUser.class})`;
            checkTodayAttendance();
            displayAttendanceHistory();
        };
        
        window.markAttendance = async (status) => {
            if (!currentUser) return;
            
            if (status === 'Hadir' && !uploadedPhotoFile) {
                showModal('Anda harus mengunggah foto untuk absen Hadir.');
                return;
            }

            Array.from(attendanceOptionsDiv.querySelectorAll('button')).forEach(b => toggleButtonLoading(b, true));
            let photoUrl = null;

            // 1. Upload photo if present
            if (status === 'Hadir' && uploadedPhotoFile) {
                const fileName = `${currentUser.name.replace(/\s+/g, '_')}_${Date.now()}`;
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from(BUCKET_NAME)
                    .upload(fileName, uploadedPhotoFile);

                if (uploadError) {
                    showModal(`Gagal mengunggah foto: ${uploadError.message}`);
                    Array.from(attendanceOptionsDiv.querySelectorAll('button')).forEach(b => toggleButtonLoading(b, false));
                    return;
                }
                
                const { data: urlData } = supabaseClient.storage.from(BUCKET_NAME).getPublicUrl(fileName);
                photoUrl = urlData.publicUrl;
            }

            // 2. Insert attendance record
            const todayString = getTodayDateString();
            const { error: insertError } = await supabaseClient
                .from('attendance')
                .insert([{
                    student_name: currentUser.name,
                    class: currentUser.class,
                    date: todayString,
                    status: status,
                    photo_url: photoUrl
                }]);
            
            Array.from(attendanceOptionsDiv.querySelectorAll('button')).forEach(b => toggleButtonLoading(b, false));

            if (insertError) {
                showModal(`Gagal menyimpan absensi: ${insertError.message}`);
            } else {
                showModal(`Kehadiran sebagai '${status}' berhasil dicatat!`);
                checkTodayAttendance();
                displayAttendanceHistory();
            }
        };
        
        const checkTodayAttendance = async () => {
            const todayString = getTodayDateString();
            const { data, error } = await supabaseClient
                .from('attendance')
                .select('status')
                .eq('student_name', currentUser.name)
                .eq('date', todayString)
                .single();

            const statusDiv = document.getElementById('attendance-status');
            if (data) {
                attendanceOptionsDiv.classList.add('hidden');
                document.getElementById('photo-section').classList.add('hidden');
                statusDiv.classList.remove('hidden');
                statusDiv.querySelector('p').textContent = `Anda sudah absen hari ini: ${data.status}`;
                statusDiv.className = `text-center p-4 rounded-lg status-${data.status.toLowerCase()}`;
            } else {
                attendanceOptionsDiv.classList.remove('hidden');
                document.getElementById('photo-section').classList.remove('hidden');
                statusDiv.classList.add('hidden');
            }
        };

        const displayAttendanceHistory = async () => {
            const historyBody = document.getElementById('history-table-body');
            const { data, error } = await supabaseClient
                .from('attendance')
                .select('*')
                .eq('student_name', currentUser.name)
                .order('date', { ascending: false });

            if (error) {
                historyBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">Gagal memuat riwayat.</td></tr>`;
                return;
            }
            if (data.length === 0) {
                historyBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-gray-500">Belum ada riwayat.</td></tr>`;
            } else {
                historyBody.innerHTML = data.map(att => `
                    <tr class="border-b">
                        <td class="p-3">${new Date(att.date + 'T00:00:00').toLocaleDateString('id-ID')}</td>
                        <td class="p-3"><span class="px-2 py-1 text-xs font-medium rounded-full status-${att.status.toLowerCase()}">${att.status}</span></td>
                    </tr>`).join('');
            }
        };
        
        // --- Teacher Dashboard Logic ---
        const showTeacherDashboard = () => {
            loginView.classList.add('hidden');
            teacherView.classList.remove('hidden');
            document.getElementById('teacher-greeting').textContent = `Wali Kelas: ${currentUser.name} (${currentUser.class})`;
            displayClassReport();
        };

        const displayClassReport = async () => {
            const reportBody = document.getElementById('report-table-body');
            const todayString = getTodayDateString();
            const { data, error } = await supabaseClient
                .from('attendance')
                .select('*')
                .eq('class', currentUser.class)
                .eq('date', todayString);

            if (error) {
                 reportBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-red-500">Gagal memuat laporan.</td></tr>`;
                 return;
            }
            if (data.length === 0) {
                reportBody.innerHTML = `<tr><td colspan="4" class="text-center p-4 text-gray-500">Belum ada siswa yang absen hari ini.</td></tr>`;
            } else {
                reportBody.innerHTML = data.map(att => `
                    <tr class="border-b">
                        <td class="p-3">${att.student_name}</td>
                        <td class="p-3">${att.class}</td>
                        <td class="p-3"><span class="px-2 py-1 text-xs font-medium rounded-full status-${att.status.toLowerCase()}">${att.status}</span></td>
                        <td class="p-3">
                            ${att.photo_url ? `<img src="${att.photo_url}" alt="Bukti" class="photo-thumbnail" onclick="showPhotoModal(this.src)">` : '<span>-</span>'}
                        </td>
                    </tr>`).join('');
            }
        };
    </script>
</body>
</html>

